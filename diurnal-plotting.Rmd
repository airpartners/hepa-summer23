```{r}
# Imports
library(tidyverse)
library(ggplot2)
library(chron)
library(data.table)
```

```{r}
# Define indoor file to be imported, set time of HEPA purifier install
indoor_file <- 'data/CM_M_250_indoor.csv'
outdoor_file <- 'data/CM_M_250_outdoor.csv'
hepa_time <- "2023-02-10 15:30:00"
```

## Import and prepare data
```{r}
# Import indoor data
indoor_data <- read.csv(indoor_file)

# Import outdoor data
outdoor_data <- read.csv(outdoor_file)
```

```{r}
# reformat timestamps to time object
indoor_data$date <- as.POSIXct(strptime(indoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
indoor_data$date_round <- round_date(indoor_data$date, unit = "minute")

outdoor_data$date <- as.POSIXct(strptime(outdoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
outdoor_data$date_round <- round_date(outdoor_data$date, unit = "minute")
```

```{r}
# adds a boolean column depending on whether the day is a wknd or not
indoor_data$is_wknd <- is.weekend(indoor_data$date)
outdoor_data$is_wknd <- is.weekend(outdoor_data$date)
```

```{r}
# isolate time
indoor_data$time <- as.ITime(indoor_data$date_round)
outdoor_data$time <- as.ITime(outdoor_data$date_round)

# convert back to datetime object (will assign today's date to all)
indoor_data$time <- as.POSIXct(indoor_data$time, format="%H:%M:%S")
outdoor_data$time <- as.POSIXct(outdoor_data$time, format="%H:%M:%S")

# create new dataframes with summary data to plot (mean/median)
sum_indoor_data <- summary_dataframe(indoor_data)
sum_outdoor_data <- summary_dataframe(outdoor_data)

# restructure dataframes for graphing
graph_indoor_data <- pivot_longer(sum_indoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")
graph_outdoor_data <- pivot_longer(sum_outdoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")
```

```{r}
diurnal_plot(graph_indoor_data, "Indoor", "1")
diurnal_plot(graph_indoor_data, "Indoor", "2.5")
diurnal_plot(graph_indoor_data, "Indoor", "10")

diurnal_plot(graph_outdoor_data, "Oudoor", "1")
diurnal_plot(graph_outdoor_data, "Oudoor", "2.5")
diurnal_plot(graph_outdoor_data, "Oudoor", "10")
```

```{r}
# necessary functions


# function to create a new dataframe with summary data
summary_dataframe <- function(data) {
  data %>%
  group_by(is_wknd, time) %>%
  summarise(mean_1 = mean(pm1), mean_2.5 = mean(pm25), mean_10 = mean(pm10), median_1 = median(pm1), median_2.5 = median(pm25), median_10 = median(pm10), percent5_1 = quantile(na.omit(pm1), 0.05), percent25_1 = quantile(na.omit(pm1), 0.25), percent75_1 = quantile(na.omit(pm1), 0.75), percent95_1 = quantile(na.omit(pm1), 0.95), percent5_2.5 = quantile(na.omit(pm25), 0.05), percent25_2.5 = quantile(na.omit(pm25), 0.25), percent75_2.5 = quantile(na.omit(pm25), 0.75), percent95_2.5 = quantile(na.omit(pm25), 0.95), percent5_10 = quantile(na.omit(pm10), 0.05), percent25_10 = quantile(na.omit(pm10), 0.25), percent75_10 = quantile(na.omit(pm10), 0.75), percent95_10 = quantile(na.omit(pm10), 0.95))
}



# function to create diurnal plots
diurnal_plot <- function(data, env_str, pm_str) {
  wknd_labels <- as_labeller(c('TRUE' = "Weekend",
                    'FALSE' = "Weekday"))

  graph_labels <- c(env_str, pm_str, 'Concentration vs. Time of Day on Weekends vs. Weekdays')
  
  data <- filter(graph_indoor_data, particle == pm_str)
  
  ggplot(data) +
    geom_ribbon(aes(x = time, ymin = percent5, ymax = percent95, fill = "#cfcfcf")) +
    geom_ribbon(aes(x = time, ymin = percent25, ymax = percent75, fill = "#7a7a7a")) +
    geom_line(aes(x = time, y = mean, color = "red")) +
    geom_line(aes(x = time, y = median, color = "blue")) +
    facet_grid(is_wknd ~ ., labeller = wknd_labels) +
    scale_color_identity(name = "Averages",
                            breaks = c("red", "blue"),
                            labels = c("Mean", "Median"),
                            guide = "legend") +
    scale_fill_identity(name = "Percentiles",
                            breaks = c("#7a7a7a", "#cfcfcf"),
                            labels = c("25th - 75th", "5th - 95th"),
                            guide = "legend") +
    scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:00") +
    labs(title = bquote(.(graph_labels[1]) ~ PM[.(graph_labels[2])] ~ .(graph_labels[3])),
         x = "Time of Day",
         y = expression("PM"[1]*" Concentration")) +
    theme_bw()
}
```
