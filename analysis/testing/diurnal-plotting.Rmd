```{r}
# Imports
library(tidyverse)
library(ggplot2)
library(chron)
library(data.table)
```

```{r}
# Define indoor file to be imported, set time of HEPA purifier install
before_indoor_file <- "data/CM_M_104_before_indoor.csv"
after_indoor_file <- "data/CM_M_104_after_indoor.csv"

before_outdoor_file <- "data/CM_M_104_before_outdoor.csv"
after_outdoor_file <- "data/CM_M_104_after_outdoor.csv"
```

## Import and prepare data
```{r}
# Import indoor data
before_indoor_data <- read.csv(before_indoor_file)
after_indoor_data <- read.csv(after_indoor_file)

# Import outdoor data
before_outdoor_data <- read.csv(before_outdoor_file)
after_outdoor_data <- read.csv(after_outdoor_file)
```

```{r}
# reformat timestamps to time object
before_indoor_data$date <- as.POSIXct(strptime(before_indoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
before_indoor_data$date_round <- round_date(before_indoor_data$date, unit = "minute")

after_indoor_data$date <- as.POSIXct(strptime(after_indoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
after_indoor_data$date_round <- round_date(after_indoor_data$date, unit = "minute")

before_outdoor_data$date <- as.POSIXct(strptime(before_outdoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
before_outdoor_data$date_round <- round_date(before_outdoor_data$date, unit = "minute")

after_outdoor_data$date <- as.POSIXct(strptime(after_outdoor_data$timestamp_local, format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))
after_outdoor_data$date_round <- round_date(after_outdoor_data$date, unit = "minute")
```

```{r}
# adds a boolean column depending on whether the day is a wknd or not
before_indoor_data$is_wknd <- is.weekend(before_indoor_data$date)
after_indoor_data$is_wknd <- is.weekend(after_indoor_data$date)

before_outdoor_data$is_wknd <- is.weekend(before_outdoor_data$date)
after_outdoor_data$is_wknd <- is.weekend(after_outdoor_data$date)
```

```{r}
# isolate time
before_indoor_data$time <- as.ITime(before_indoor_data$date_round)
after_indoor_data$time <- as.ITime(after_indoor_data$date_round)

before_outdoor_data$time <- as.ITime(before_outdoor_data$date_round)
after_outdoor_data$time <- as.ITime(after_outdoor_data$date_round)

# convert back to datetime object (will assign today's date to all)
before_indoor_data$time <- as.POSIXct(before_indoor_data$time, format="%H:%M:%S")
after_indoor_data$time <- as.POSIXct(after_indoor_data$time, format="%H:%M:%S")

before_outdoor_data$time <- as.POSIXct(before_outdoor_data$time, format="%H:%M:%S")
after_outdoor_data$time <- as.POSIXct(after_outdoor_data$time, format="%H:%M:%S")
```

```{r}
before_indoor_data <- subset(before_indoor_data, pm1 < 200)
after_indoor_data <- subset(after_indoor_data, pm1 < 200)
before_outdoor_data <- subset(before_outdoor_data, pm1 < 25)
after_outdoor_data <- subset(after_outdoor_data, pm1 < 25)

before_indoor_data <- subset(before_indoor_data, pm25 < 250)
after_indoor_data <- subset(after_indoor_data, pm25 < 250)
before_outdoor_data <- subset(before_outdoor_data, pm25 < 50)
after_outdoor_data <- subset(after_outdoor_data, pm25 < 50)

before_indoor_data <- subset(before_indoor_data, pm10 < 1000)
after_indoor_data <- subset(after_indoor_data, pm10 < 1000)
before_outdoor_data <- subset(before_outdoor_data, pm10 < 500)
after_outdoor_data <- subset(after_outdoor_data, pm10 < 500)

# length(which(before_indoor_data$pm1 > 200))
# length(which(after_indoor_data$pm1 > 200))
# length(which(before_outdoor_data$pm1 > 25))
# length(which(after_outdoor_data$pm1 > 25))

# length(which(before_indoor_data$pm25 > 250))
# length(which(after_indoor_data$pm25 > 250))
# length(which(before_outdoor_data$pm25 > 50))
# length(which(after_outdoor_data$pm25 > 50))

# length(which(before_indoor_data$pm10 > 1000))
# length(which(after_indoor_data$pm10 > 1000))
# length(which(before_outdoor_data$pm10 > 500))
# length(which(after_outdoor_data$pm10 > 500))
```

```{r}
# create new dataframes with summary data to plot (mean/median)
sum_before_indoor_data <- summary_dataframe(before_indoor_data)
sum_after_indoor_data <- summary_dataframe(after_indoor_data)

sum_before_outdoor_data <- summary_dataframe(before_outdoor_data)
sum_after_outdoor_data <- summary_dataframe(after_outdoor_data)

# restructure dataframes for graphing
graph_before_indoor_data <- pivot_longer(sum_before_indoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")
graph_after_indoor_data <- pivot_longer(sum_after_indoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")

graph_before_outdoor_data <- pivot_longer(sum_before_outdoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")
graph_after_outdoor_data <- pivot_longer(sum_after_outdoor_data, mean_1:percent95_10, names_to = c(".value", "particle"), names_sep = "_")
```

```{r}
diurnal_plot(graph_before_indoor_data, "Before", "Indoor", "1")
diurnal_plot(graph_before_indoor_data, "Before", "Indoor", "2.5")
diurnal_plot(graph_before_indoor_data, "Before", "Indoor", "10")

diurnal_plot(graph_after_indoor_data, "After", "Indoor", "1")
diurnal_plot(graph_after_indoor_data, "After", "Indoor", "2.5")
diurnal_plot(graph_after_indoor_data, "After", "Indoor", "10")

diurnal_plot(graph_before_outdoor_data, "Before", "Outdoor", "1")
diurnal_plot(graph_before_outdoor_data, "Before", "Outdoor", "2.5")
diurnal_plot(graph_before_outdoor_data, "Before", "Outdoor", "10")

diurnal_plot(graph_after_outdoor_data, "After", "Outdoor", "1")
diurnal_plot(graph_after_outdoor_data, "After", "Outdoor", "2.5")
diurnal_plot(graph_after_outdoor_data, "After", "Outdoor", "10")

## same scale for before and after, compare outdoor scales/log axis, copy + paste vedaant's data formatting function
```

```{r}
# necessary functions


# function to create a new dataframe with summary data
summary_dataframe <- function(data) {
  data %>%
  group_by(is_wknd, time) %>%
  summarise(mean_1 = mean(pm1), mean_2.5 = mean(pm25), mean_10 = mean(pm10), median_1 = median(pm1), median_2.5 = median(pm25), median_10 = median(pm10), percent5_1 = quantile(na.omit(pm1), 0.05), percent25_1 = quantile(na.omit(pm1), 0.25), percent75_1 = quantile(na.omit(pm1), 0.75), percent95_1 = quantile(na.omit(pm1), 0.95), percent5_2.5 = quantile(na.omit(pm25), 0.05), percent25_2.5 = quantile(na.omit(pm25), 0.25), percent75_2.5 = quantile(na.omit(pm25), 0.75), percent95_2.5 = quantile(na.omit(pm25), 0.95), percent5_10 = quantile(na.omit(pm10), 0.05), percent25_10 = quantile(na.omit(pm10), 0.25), percent75_10 = quantile(na.omit(pm10), 0.75), percent95_10 = quantile(na.omit(pm10), 0.95))
}



# function to create diurnal plots + save as an svg
diurnal_plot <- function(data, time_str, env_str, pm_str) {
  wknd_labels <- as_labeller(c("TRUE" = "Weekend",
                    "FALSE" = "Weekday"))

  graph_labels <- c("Daily", env_str, pm_str, "Trends", time_str, "Purifier Install")
  
  data <- filter(data, particle == pm_str)
  
  # # svg file to save graph
  # svg(paste(tolower(time_str), tolower(env_str), pm_str, sep = "_"))
  
  ggplot(data) +
    geom_ribbon(aes(x = time, ymin = percent5, ymax = percent95, fill = "#cfcfcf")) +
    geom_ribbon(aes(x = time, ymin = percent25, ymax = percent75, fill = "#7a7a7a")) +
    geom_line(aes(x = time, y = mean, color = "red")) +
    geom_line(aes(x = time, y = median, color = "blue")) +
    facet_grid(is_wknd ~ ., labeller = wknd_labels) +
    scale_color_identity(name = "Averages",
                            breaks = c("red", "blue"),
                            labels = c("Mean", "Median"),
                            guide = "legend") +
    scale_fill_identity(name = "Percentiles",
                            breaks = c("#cfcfcf", "#7a7a7a"),
                            labels = c("5th - 95th", "25th - 75th"),
                            guide = "legend") +
    scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:00") +
    labs(title = bquote(.(graph_labels[1]) ~ .(graph_labels[2]) ~ PM[.(graph_labels[3])] ~ .(graph_labels[4]) ~ .(graph_labels[5]) ~ .(graph_labels[6])),
         x = "Time of Day (hrs)",
         y = expression("PM"[1]*" Concentration")) +
    scale_y_log10() +
    # scale_y_log10(limits = c(1e-1,1e2)) +
    # ylim(0,80) +
    theme_bw()
  
  # # close the graphics device
  # dev.off() 
}
```
