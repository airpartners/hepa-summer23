# HAFTRAP Data Cleaning and Summaries - multiple
This script is an initial builder to generate figures for multiple participants in the HAFTRAP study, using deployments by Olin. It is largely a copy of `OH_modpm_single_stats.Rmd`, but scaled up to deal with multiple participants. Ensure that each participant has indoor and outdoor data for both sham and HEPA stages, all files labelled appropriately.
```{r}
# Import relevant libraries
library(tidyverse)
library(openair)
library(corrplot)
library(ggplot2)
library(ggpmisc)

```

```{r}
# Get file path
getwd()

# # If file path doesn't end with the root folder "hepa-summer23", set to that folder on your PC
# setwd(dir)
```

```{r}
# Vector of participant numbers' data to be processed
participants <- c("41181")
```

```{r}
# Set path to data
path_to_data <- "data/HAFTRAP/OH/modpm/"

# Set data category
data_cat <- "OH_M"
```

### Loop to load all data. Ensure that all functions in the code blocks after this loop are loaded. Run this carefully, checking everything, and only once!
```{r}
# Initialize master dataframe for all data
main_df <- data.frame()

# Loop through each participant
for (p in participants) {
  # Loop through each case
  for (case in c("sham", "hepa")) {
    # Loop through each environment
    for (env in c("indoor", "outdoor")) {
      # Set file path
      file_name <- paste(data_cat, p, case, env, sep = "_")
      file_path <- paste0(path_to_data, file_name, ".csv")
      
      # Read csv
      df <- read_csv(file_path, show_col_types = FALSE)
      
      # Add the category type
      df <- mutate(df, case = case, environment = env, participant_id = p)
      main_df <- rbind(main_df, df)
    }
  }
}

```

```{r}
# Processing data

# Reformat timestamps and round to nearest minute
main_df <- improve_timestamps(main_df)

# Calculate particle counts and remove unnecessary columns
main_df <- sum_bins(main_df)
```

```{r}
# Create separate indoor and outdoor columns
main_df_wide <- pivot_wider(main_df, names_from = environment, values_from = c(pm1, pm25, pm10, pm1num))
```

```{r}
# Divide indoor by outdoor to calculate ratios
df_ratio <- select(main_df_wide, ends_with("indoor"))/
  select(main_df_wide, ends_with("outdoor"))

# Rename columns
colnames(df_ratio) <- sub("indoor", "ratio", colnames(df_ratio))

# Merge back with joined data-frame and return
main_df_wide <- cbind(main_df_wide, df_ratio)
```

```{r}
main_df_normal <- pivot_longer(main_df_wide, pm1_indoor:pm1num_ratio, 
                               names_to = c(".value", "environment"), 
                               names_sep = "_")
```

```{r}
main_df_long <- pivot_longer(main_df_normal, pm1:pm1num, names_to = "particle", values_to = "conc")

```

```{r}
main_df_long <- drop_na(main_df_long)
```


```{r}
grouped_df_long <- group_by(main_df_long, participant_id, case, environment, particle)
```

```{r}
summary <- summarise(grouped_df_long, 
              mean = mean(conc),
              median = median(conc), 
              q5 = quantile(conc, probs = 0.05), 
              q25 = quantile(conc, probs = 0.25),
              q75 = quantile(conc, probs = 0.75),
              q95 = quantile(conc, probs = 0.95),
              .groups = 'drop')
```

```{r}
summary_wide <- pivot_wider(summary, names_from = case, values_from = mean:q95)
```

```{r}
# Divide indoor by outdoor to calculate ratios
summary_redu <- 100*(select(summary_wide, ends_with("sham")) - 
  select(summary_wide, ends_with("hepa"))) / select(summary_wide, ends_with("sham"))

# Rename columns
colnames(summary_redu) <- sub("sham", "redu", colnames(summary_redu))

# Merge back with joined data-frame and return
summary_wide <- cbind(summary_wide, summary_redu)
```

```{r}
summary_normal <- pivot_longer(summary_wide, mean_hepa:q95_redu, 
                               names_to = c(".value", "case"), 
                               names_sep = "_")
```

### Reformatting timestamps
Necessary since the timestamps from QuantAQ are in a weird format and need to be formatted to a format that works with the openair plotting package. An added column rounding the times to the nearest minute is calculated since two data-frames will be merged later in this script on the basis of time.

```{r}
# Function to reformat time-stamps to time object and round to nearest minute
improve_timestamps <- function(df) {
  df %>%
    # Reformat timestamps to sensible format
    # mutate(date = as.POSIXct(strptime(timestamp_local, 
    #   format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))) %>%
    mutate(date = as.POSIXct(timestamp, tz = "America/New_York")) %>%
    # Round times to nearest minute
    mutate(date = round_date(date, unit = "minute"))
}
```

### Particle counts and removing unnecessary data
Alongside particle masses, we are concerned with the counts of particles that fall under certain size bins. To approximate the counts under pm1, sum up bin 0 to 2. Discard all other data columns that are not relevant.

```{r}
# Function to calculate sums of particle counts, remove rest
sum_bins <- function(df) {
  df %>%
    # Sum particle counts
    mutate(pm1num = bin0 + bin1 + bin2) %>%
    # Delete unnecessary columns
    select(pm1:pm1num) %>%
    select(-ends_with("_model_id"))
}

```

### Calculate correlation matrices
Helps better understand the relationship between different variables in sham and true HEPA conditions.
```{r}
# Function to calculate correlation matrices
get_corr <- function(joined_data) {
  joined_data %>%
    # Select all columns except date
    select(-date) %>%
    # Remove NaN values
    na.omit() %>%
    # Calculate correlations for all complete pairs
    cor(use = "p")
}
```

```{r}
# Calculate correlation matrices for sham and hepa
N_sham <- get_corr(sham_joined_data)
N_hepa <- get_corr(hepa_joined_data)
```

```{r}
# Visual check
head(N_sham, 2)
```

### Save to file
Summary statistics are saved in a series of csv files. The naming convention of these files is specified by in `data_guide.md`
```{r}
# Save summary statistic files to CSVs
write.csv(summary_all, "summary/HAFTRAP/OH/modpm/s_OH_M_41181_quants.csv")
write.csv(N_sham, "summary/HAFTRAP/OH/modpm/s_OH_M_41181_corr_sham.csv")
write.csv(N_hepa, "summary/HAFTRAP/OH/modpm/s_OH_M_41181_corr_hepa.csv")
```
