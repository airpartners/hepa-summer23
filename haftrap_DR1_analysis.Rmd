# HAFTRAP Data Cleaning and Summaries
```{r}
# Imports
library(tidyverse)
library(openair)
library(corrplot)
library(ggplot2)
library(ggpmisc)

```

```{r}
# Define files to be imported
is_file <- 'data/HAFTRAP_sham_indoor.csv'
os_file <- 'data/HAFTRAP_sham_outdoor.csv'
ih_file <- 'data/HAFTRAP_hepa_indoor.csv'
oh_file <- 'data/HAFTRAP_hepa_outdoor.csv'
```

## Import and prepare data
```{r}
# Import indoor sham data
sham_indoor <- read.csv(is_file)

# Import outdoor sham data
sham_outdoor <- read.csv(os_file)

# Import indoor hepa data
hepa_indoor <- read.csv(ih_file)

# Import outdoor hepa data
hepa_outdoor <- read.csv(oh_file)

```

```{r}
# View sample of dataframe
head(hepa_indoor, 5)
```

### Reformatting timestamps
Necessary since the timestamps from QuantAQ are in a weird format and need to be formatted to a format that works with the openair plotting package. An added column rounding the times to the nearest minute is calculated since two dataframes will be merged in the future based on time. 
```{r}
# Function to reformat timestamps to time object and round to nearest minute
improve_timestamps <- function(df) {
  df %>%
    # Reformat timestamps to sensible format
    mutate(date = as.POSIXct(strptime(timestamp_local, 
      format = "%Y-%m-%dT%H:%M:%SZ", tz = "America/New_York"))) %>%
    # Round times to nearest minute
    mutate(date_round = round_date(date, unit = "minute"))
}
```

```{r}
# Reformat timestamps and add rounding for future merges
sham_indoor <- improve_timestamps(sham_indoor)
sham_outdoor <- improve_timestamps(sham_outdoor)
hepa_indoor <- improve_timestamps(hepa_indoor)
hepa_outdoor <- improve_timestamps(hepa_outdoor)
```

```{r}
# Check if data frame updated
head(hepa_indoor, 3)
```

### Particle counts and removing unnecessary data
Alongside particle masses, we are concerned with the counts of particles that fall under certain size bins. To approximate the counts under pm1, sum up bin 0 to 2. Discard all other data columns that are not relevant.
```{r}
# function to calculate sums of particle counts, remove rest
sum_bins <- function(df) {
  df %>%
    # Sum particle counts
    mutate(pm1_num = bin0 + bin1 + bin2) %>%
    # Delete unnecessary columns
    select(pm1:pm1_num) %>%
    select(-ends_with("_model_id"))
}

```


```{r}
# Calculate particle counts and remove unnecessary columns
sham_indoor <- sum_bins(sham_indoor)
sham_outdoor <- sum_bins(sham_outdoor)
hepa_indoor <- sum_bins(hepa_indoor)
hepa_outdoor <- sum_bins(hepa_outdoor)

```

```{r}
# View dataframe
head(sham_indoor)
```


### Rename and merge
Merge indoor and outdoor data into a single dataframe for easier comparison and calculation of correlation
```{r}
# Append all variables with "outdoor_" or "indoor_" respectively
colnames(sham_indoor) <- paste0('indoor_', colnames(sham_indoor))
colnames(sham_outdoor) <- paste0('outdoor_', colnames(sham_outdoor))

colnames(hepa_indoor) <- paste0('indoor_', colnames(hepa_indoor))
colnames(hepa_outdoor) <- paste0('outdoor_', colnames(hepa_outdoor))
```

```{r, results = 'hide'}
# Time-sync indoor, outdoor data
# Join dataframes by syncing rounded date columns. Run this only ONCE!
sham_joined_data <- left_join(sham_indoor, sham_outdoor, by = c("indoor_date_round" = "outdoor_date_round")) %>% drop_na()

hepa_joined_data <- left_join(hepa_indoor, hepa_outdoor, by = c("indoor_date_round" = "outdoor_date_round")) %>% drop_na()

# Renaming synced date columns back to just 'date'
sham_joined_data$date <- sham_joined_data$indoor_date
hepa_joined_data$date <- hepa_joined_data$indoor_date

# Removing extra date columns
sham_joined_data <- select(sham_joined_data, -contains("_date"))
hepa_joined_data <- select(hepa_joined_data, -contains("_date"))
```

```{r}
colnames(sham_joined_data)
```


### Compute indoor/outdoor ratios
To ascertain whether changes in indoor air pollution are due to changes in indoor conditions, as opposed to changes in outdoor air pollution.

```{r}
# Function to calculate indoor-outdoor ratios
calc_ratios <- function(joined_data) {
  # Divide indoor by outdoor to calculate ratios
  df_ratio <- select(joined_data, starts_with("indoor_"))/
    select(joined_data, starts_with("outdoor_"))
  
  # Rename columns
  colnames(df_ratio) <- sub("indoor_", "ratio_", colnames(df_ratio))
  # Merge back into original data-frame and return
  cbind(joined_data, df_ratio)
}
```
```{r}
# Calculate ratios for sham and hepa data. Run this only ONCE!
sham_joined_data <- calc_ratios(sham_joined_data)
hepa_joined_data <- calc_ratios(hepa_joined_data)
```


### Calculate various summary statistics of the data
Now comes the step where we use all the processed and merged data so far to calculate summary statistics about indoor, outdoor, and ratio data.
```{r}
# Function to calculate mean, median, and various quantiles of a given vector
sum_data <- function(time_series) {
  my_mean <- mean(time_series)
  quantiles <- quantile(time_series, probs=c(0.05, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE)
  # Reorganizing vector so that mean and median are at beginning
  median <- quantiles[3]
  c("mean"=my_mean, median, quantiles[-3])
}
```

```{r}
colnames(hepa_joined_data)

```

```{r}
# Compute the summary statistics for all columns except date (obviously)
summary_sham <- apply(select(sham_joined_data , -date), 2, sum_data)
summary_hepa <- apply(select(hepa_joined_data , -date), 2, sum_data)
```

```{r}
head(summary_sham, 2)
```



```{r}
# Function to calculate percent reduction between sham and hepa
pr_func <- function(sham, hepa) {
  100*(sham - hepa)/sham
}
```

```{r}
100*(summary_sham - summary_hepa)/summary_sham
```


```{r}
s <- quantile(sham_indoor$indoor_pm25, probs=c(0.05, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE)
h <- quantile(hepa_indoor$indoor_pm25, probs=c(0.05, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE)

```

```{r}
m <- s[3]
temp <- s[-3]
temp_s <- c("mean"=mean(s), m, temp)
temp_s
```


```{r}
perc_reduct(s, h)
```


```{r}
perc_reduct(si_mean, hi_mean)
```

```{r}
si_median <- median(sham_indoor$indoor_pm25, na.rm = TRUE)
hi_median <- median(hepa_indoor$indoor_pm25, na.rm=TRUE)
so_median <- median(sham_outdoor$outdoor_pm25, na.rm = TRUE)
ho_median <- median(hepa_outdoor$outdoor_pm25, na.rm=TRUE)
```

```{r}
si_median <- median(sham_indoor$indoor_pm25, na.rm = TRUE)
```


```{r}
100*(si_median - hi_median)/si_median
```
```{r}
100*(so_median - ho_median)/so_median
```
```{r}
100*((si_mean/so_mean) - (hi_mean/ho_mean))/(si_mean/so_mean)
```

```{r}
100*((si_median/so_median) - (hi_median/ho_median))/(si_median/so_median)
```



```{r}
sham_corr_data <- select(sham_joined_data, indoor_pm1, indoor_pm25, indoor_pm10, outdoor_pm1, outdoor_pm25, outdoor_pm10)
N <- cor(na.omit(sham_corr_data), use = "p")
corrplot(N, method = 'color', main = "Sham Correlation Plot")

hepa_corr_data <- select(hepa_joined_data, indoor_pm1, indoor_pm25, indoor_pm10, outdoor_pm1, outdoor_pm25, outdoor_pm10)
N <- cor(na.omit(hepa_corr_data), use = "p")
corrplot(N, method = 'color', main = "HEPA Correlation Plot")
```


```{r}
# Sham Indoor PM 1 vs. Indoor PM 2.5
ggplot(sham_joined_data, aes(x = indoor_pm1, y = indoor_pm25)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = expression("Sham Correlation Plot (Indoor PM"[1]*" vs. Indoor PM"[2.5]*")"), x = expression("Indoor PM"[1]), y = expression("Indoor PM"[2.5])) +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# Sham Outdoor PM 1 vs. Outdoor PM 2.5
ggplot(sham_joined_data, aes(x = outdoor_pm1, y = outdoor_pm25)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Sham Correlation Plot (Outdoor PM1 vs. Outdoor PM2.5)", x = "Outdoor PM1", y = "Outdoor PM2.5") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# HEPA Indoor PM 1 vs. Indoor PM 2.5
ggplot(hepa_joined_data, aes(x = indoor_pm1, y = indoor_pm25)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "HEPA Correlation Plot (Indoor PM1 vs. Indoor PM2.5)", x = "Indoor PM1", y = "Indoor PM2.5") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# HEPA Indoor PM 2.5 vs. Indoor PM 10
ggplot(hepa_joined_data, aes(x = indoor_pm25, y = indoor_pm10)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "HEPA Correlation Plot (Indoor PM2.5 vs. Indoor PM10)", x = "Indoor PM2.5", y = "Indoor PM10") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# HEPA Outdoor PM 2.5 vs. Outdoor PM 10
ggplot(hepa_joined_data, aes(x = outdoor_pm25, y = outdoor_pm10)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "HEPA Correlation Plot (Outdoor PM2.5 vs. Outdoor PM10)", x = "Outdoor PM2.5", y = "Outdoor PM10") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# HEPA Indoor PM 2.5 vs. Outdoor PM 2.5
ggplot(hepa_joined_data, aes(x = indoor_pm25, y = outdoor_pm25)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "HEPA Correlation Plot (Indoor PM2.5 vs. Outdoor PM2.5)", x = "Indoor PM2.5", y = "Outdoor PM2.5") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))

# Sham Indoor PM 2.5 vs. Outdoor PM 2.5
ggplot(sham_joined_data, aes(x = indoor_pm25, y = outdoor_pm25)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Sham Correlation Plot (Indoor PM2.5 vs. Outdoor PM2.5)", x = "Indoor PM2.5", y = "Outdoor PM2.5") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))


```
```{r}
# Sham Indoor PM 1 vs. Outdoor PM 1
ggplot(sham_joined_data, aes(x = indoor_pm1, y = outdoor_pm1)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Sham Correlation Plot (Indoor PM1 vs. Outdoor PM1)", x = "Indoor PM10", y = "Outdoor PM1") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))
```

```{r}
# Hepa Indoor PM 1 vs. Outdoor PM 1
ggplot(hepa_joined_data, aes(x = indoor_pm1, y = outdoor_pm1)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Hepa Correlation Plot (Indoor PM1 vs. Outdoor PM1)", x = "Indoor PM1", y = "Outdoor PM1") +
  stat_poly_eq(formula = x ~ y,
               aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")))
```



```{r}
# #Initial time series
timePlot(sham_joined_data, pollutant = c('indoor_pm1', 'indoor_pm25', 'indoor_pm10'), main = "Indoor Sham Data", normalize = TRUE, name.pol = c("pm1", "pm25", "pm10"))

timePlot(sham_joined_data, pollutant = c('outdoor_pm1', 'outdoor_pm25', 'outdoor_pm10'), main = "Outdoor Sham Data", normalize = TRUE, name.pol = c("pm1", "pm25", "pm10"))

timePlot(hepa_joined_data, pollutant = c('indoor_pm1', 'indoor_pm25', 'indoor_pm10'), main = "Indoor HEPA Data", normalize = TRUE, name.pol = c("pm1", "pm25", "pm10"))

timePlot(hepa_joined_data, pollutant = c('outdoor_pm1', 'outdoor_pm25', 'outdoor_pm10'), main = "Outdoor HEPA Data", normalize = TRUE, name.pol = c("pm1", "pm25", "pm10"))
```


```{r}
# Indoor data timevariation
timeVariation(sham_joined_data, pollutant = c("indoor_pm1", "indoor_pm25", "indoor_pm10"))

timeVariation(hepa_joined_data, pollutant = c("indoor_pm1", "indoor_pm25", "indoor_pm10"))

# Outdoor data timevariation
timeVariation(sham_joined_data, pollutant = c("outdoor_pm1", "outdoor_pm25", "outdoor_pm10"))

timeVariation(hepa_joined_data, pollutant = c("outdoor_pm1", "outdoor_pm25", "outdoor_pm10"))
```
