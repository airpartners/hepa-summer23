# Sham vs. HEPA - is there a difference?
This notebook investigates whether the installation of air purifiers had a notable impact on indoor air quality across various summary metrics. It uses summary data found in `summary/HAFTRAP/OH`

```{r}
library(ggplot2)
library(tidyverse)
```

Set working directory
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'C:/Users/vkuchhal/Documents/hepa-summer23')
```

```{r}
# Get file path
if (!endsWith(getwd(), "hepa-summer23")) {
  stop("Incorrect working directory")
}
```

```{r}
path_to_data <- "summary/HAFTRAP/OH/"
```


## Boxplots galore
One common way to visualize the reduction in air pollutant concentration is by plotting side-by-side comparison boxplots of distributions of various summary statistics between sham and HEPA. Depending on the summary statistic in question, the plots reveal different insights about the data.

### CPC
```{r}
filepath <- paste0(path_to_data, "s_OH_C_quants.csv")
cpc_stats <- read_csv(filepath, show_col_types = FALSE)
```
#### CPC Indoor
```{r}
# Filter and reshape for indoor
current_data <- cpc_stats %>% 
  # Filter only for indoor, concent variables
  filter(environment == "indoor", type == "concent") %>%
  
  # Gather dataframe to create single variable for measurements
  pivot_longer(mean:sd, names_to = "d_type", values_to = "reading")

# Find average percent reduction for each summary statistic type
current_data %>%
  filter(case == "redu") %>%
  group_by(d_type) %>%
  summarise(averages = mean(reading)) -> vals

# Convert values to string statements, place into dataframe
dat_text <- data.frame(
  label = paste0("% reduction = ", round(vals$averages, 1), "%"),
  d_type   = vals$d_type
)

# Loop through and plot for each summary data type
# (More efficient with group_by, group_split, lapply but clearer code here)
for (dtype in unique(current_data$d_type)) {
  # Filter out relevant data for current data type
  plot_data <- current_data %>% 
    filter(case %in% c("sham", "hepa")) %>%
    filter(d_type == dtype)
    
  # Plot data
  print(ggplot(data = plot_data) +
    # Create boxplot for sham and HEPA
    geom_boxplot(mapping = aes(x = case, y = reading, fill = case)) +
    # Add title
    ggtitle(paste("Reduction in", dtype, "indoor CPC particle count")) +
    # Add label with percentage reduction
    geom_text(data = dat_text %>% filter(d_type == dtype), 
            mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust   = -2, vjust   = -24, fontface="bold"))
}
```

#### CPC Ratio
```{r}
# Filter and reshape for ratio
current_data <- cpc_stats %>% 
  # Filter only for ratio, concent variables
  filter(environment == "ratio", type == "concent") %>%
  
  # Gather dataframe to create single variable for measurements
  pivot_longer(mean:sd, names_to = "d_type", values_to = "reading")

# Find average percent reduction for each summary statistic type
current_data %>%
  filter(case == "redu") %>%
  group_by(d_type) %>%
  summarise(averages = mean(reading)) -> vals

# Convert values to string statements, place into dataframe
dat_text <- data.frame(
  label = paste0("% reduction = ", round(vals$averages, 1), "%"),
  d_type   = vals$d_type
)

# Loop through and plot for each summary data type
# (More efficient with group_by, group_split, lapply but clearer code here)
for (dtype in unique(current_data$d_type)) {
  # Filter out relevant data for current data type
  plot_data <- current_data %>% 
    filter(case %in% c("sham", "hepa")) %>%
    filter(d_type == dtype)
    
  # Plot data
  print(ggplot(data = plot_data) +
    # Create boxplot for sham and HEPA
    geom_boxplot(mapping = aes(x = case, y = reading, fill = case)) +
    # Add title
    ggtitle(paste("Reduction in", dtype, "indoor CPC particle count")) +
    # Add label with percentage reduction
    geom_text(data = dat_text %>% filter(d_type == dtype), 
            mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust   = -2, vjust   = -24, fontface="bold"))
}
```

### Mod-PM

```{r}
filepath <- paste0(path_to_data, "s_OH_M_quants.csv")
modpm_stats <- read_csv(filepath, show_col_types = FALSE)
```
#### Mod-PM Indoor
```{r}
for (p_type in c("pm1", "pm25", "pm10", "pm1num")) {
  # Filter and reshape for indoor
  current_data <- modpm_stats %>% 
    # Filter only for indoor, concent variables
    filter(environment == "indoor", type == p_type) %>%
    
    # Gather dataframe to create single variable for measurements
    pivot_longer(mean:sd, names_to = "d_type", values_to = "reading")
  
  # Find average percent reduction for each summary statistic type
  current_data %>%
    filter(case == "redu") %>%
    group_by(d_type) %>%
    summarise(averages = mean(reading)) -> vals
  
  # Convert values to string statements, place into dataframe
  dat_text <- data.frame(
    label = paste0("% reduction = ", round(vals$averages, 1), "%"),
    d_type   = vals$d_type
  )
  
  # Loop through and plot for each summary data type
  for (dtype in unique(current_data$d_type)) {
    # Filter out relevant data for current data type
    plot_data <- current_data %>% 
      filter(case %in% c("sham", "hepa")) %>%
      filter(d_type == dtype)
      
    # Plot data
    print(ggplot(data = plot_data) +
      # Create boxplot for sham and HEPA
      geom_boxplot(mapping = aes(x = case, y = reading, fill = case)) +
      # Add title
      ggtitle(paste("Reduction in", dtype, "indoor", p_type,
                    "concentration")) +
      # Add label with percentage reduction
      geom_text(data = dat_text %>% filter(d_type == dtype), 
              mapping = aes(x = -Inf, y = -Inf, label = label),
              hjust   = -2, vjust   = -24, fontface="bold"))
  }
  print(paste("Plotted for", p_type))
}

```

#### Mod-PM Ratio
```{r}
for (p_type in c("pm1", "pm25", "pm10", "pm1num")) {
  # Filter and reshape for ratio
  current_data <- modpm_stats %>% 
    # Filter only for ratio, concent variables
    filter(environment == "ratio", type == p_type) %>%
    
    # Gather dataframe to create single variable for measurements
    pivot_longer(mean:sd, names_to = "d_type", values_to = "reading")
  
  # Find average percent reduction for each summary statistic type
  current_data %>%
    filter(case == "redu") %>%
    group_by(d_type) %>%
    summarise(averages = mean(reading)) -> vals
  
  # Convert values to string statements, place into dataframe
  dat_text <- data.frame(
    label = paste0("% reduction = ", round(vals$averages, 1), "%"),
    d_type   = vals$d_type
  )
  
  # Loop through and plot for each summary data type
  for (dtype in unique(current_data$d_type)) {
    # Filter out relevant data for current data type
    plot_data <- current_data %>% 
      filter(case %in% c("sham", "hepa")) %>%
      filter(d_type == dtype)
      
    # Plot data
    print(ggplot(data = plot_data) +
      # Create boxplot for sham and HEPA
      geom_boxplot(mapping = aes(x = case, y = reading, fill = case)) +
      # Add title
      ggtitle(paste("Reduction in", dtype, "indoor", p_type,
                    "concentration")) +
      # Add label with percentage reduction
      geom_text(data = dat_text %>% filter(d_type == dtype), 
              mapping = aes(x = -Inf, y = -Inf, label = label),
              hjust   = -2, vjust   = -24, fontface="bold"))
  }
  print(paste("Plotted for", p_type))
}

```



