# What are the relationships?
In the `analysis` stage, correlation coefficients were computed for every variable for each case for every participant. This notebook explores what we can learn about the relationship (and lack thereof) between different key variables

```{r}
library(tidyverse)
library(rstatix)
library(corrplot)
```

Set working directory
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/hepa-summer23")
```

```{r}
# Get file path
if (!endsWith(getwd(), "hepa-summer23")) {
  stop("Incorrect working directory")
}
```

```{r}
# Set path to data
path_to_data <- "summary/HAFTRAP/SC/"
```

## Summarizing participants
Currently, we have individual correlation coefficients for each participant. Using the merged dataframe from `OH_modpm_cpc_corrs`, we can calculate overall coefficients.

```{r}
# Read correlation coefficient data
corr_df <- read.csv(paste0(path_to_data, "s_SC_RASTC_corr.csv"))
```

```{r}
corr_df %>%
  filter(environment == "indoor", case == "off") %>%
  select(coefficient, col1, col2) %>%
  rename(var1 = col1, var2 = col2) %>%
  cor_spread(value = "coefficient") %>%
  column_to_rownames(var = "rowname")-> plot_df
```

```{r}

plot_matrix <- data.matrix(plot_df)

# Get the number of variables
num_vars <- nrow(plot_matrix) + 1

# Create a complete symmetric matrix with ones on the diagonal
complete_matrix <- diag(1, num_vars, num_vars)

complete_matrix[lower.tri(complete_matrix, diag = FALSE)] <-
  plot_matrix[lower.tri(t(plot_matrix))]

complete_matrix[upper.tri(complete_matrix, diag = FALSE)] <-
  plot_matrix[upper.tri(plot_matrix)]

rownames(complete_matrix) <- union(unique(corr_df$col1), unique(corr_df$col2))
colnames(complete_matrix) <- rownames(complete_matrix)
```

```{r}
corrplot(data.matrix(complete_matrix), method = "color")
```


```{r}
corrplot(data.matrix(plot_df), method = "color")
```

```{r}
half_df <- corr_df %>% 
  filter(environment == "indoor", case == "off") %>% 
  select(coefficient, col1, col2)

copy_half_df <- half_df

colnames(copy_half_df) <- c("coefficient", "col2", "col1")

almost_whole_df <- rbind(half_df, copy_half_df)

all_vars <- union(unique(corr_df$col1), unique(corr_df$col2))

ones_df <- data.frame(col1 = all_vars, col2 = all_vars, 
                      coefficient = rep(1, length(all_vars)))

whole_df <- rbind(almost_whole_df, ones_df)
```

```{r}
whole_df %>%
  rename(var1 = col1, var2 = col2) %>%
  cor_spread(value = "coefficient") %>%
  column_to_rownames(var = "rowname")-> plot_df
```

```{r}
plot_df <- plot_df[order(rownames(plot_df)), order(names(plot_df))]
```

```{r}
# Set graphical parameters to adjust margin and text size globally
corrplot(data.matrix(plot_df), method = "color", order = "AOE")
```
```{r}
selected_vars <- c("mod_pm1", "mcpc_counts", "acsm_org", "t200u_no", "t200u_no2", "t300_co", "acsm_ratio_55_57")

cor_matrix <- data.matrix(plot_df)
subset_matrix <- cor_matrix[selected_vars, selected_vars]

# Set graphical parameters to adjust margin and text size globally
corrplot(subset_matrix, method = "number")
```


